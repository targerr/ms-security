<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Index</title>
</head>
<body>
<h1>welcome to 系统1</h1>
<div id="loginTip"></div>
<p><button onclick="getOrderInfo()">获取订单信息</button></p>

<table>
    <tr><td>order id</td><td><input id="orderId" /></td></tr>
    <tr><td>order product id</td><td><input id="productId" /></td></tr>
</table>




</body>
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script>


    function getOrderInfo(){
        $.get("api/order/orders/1",function(data){
            $("#orderId").val(data.id);
            $("#productId").val(data.productId);
        }).fail(function () {
            alert('获取订单失败！');
        });;
    }

    function logout() {
        //1，将客户端应用的session失效掉
        $.get("/logout",function(data){
            //2，将认证服务器的session失效, /logout 是SpringSecurity OAuth默认的退出过滤器
            // org.springframework.security.web.authentication.ui.DefaultLogoutPageGeneratingFilter
            window.location.href = "http://auth.nb.com:9090/logout?redirect_uri=http://admin.nb.com:8080/index";
        });
    }

    //拦截全局错误响应
    $(document).ajaxError(function( event, response, settings ) {
        //response打印出来是这样式的：
        //{"readyState":4,"responseText":"{\"message\":\"refresh fail\"}","responseJSON":{"message":"refresh fail"},"status":401,"statusText":"error"}
        //alert(JSON.stringify(request));
        if (response.status == 500 && response.responseJSON.message =='refresh fail') {
            //alert("登录失效！请重新登录！");
            //在这里处理，登录失效让用户去认证服务器走1遍退出流程
            logout();

            //如果refresh_token失效了,还不想让失效，去认证服务器看session
//            window.location.href="http://auth.nb.com:9090/oauth/authorize?"
//                +"client_id=admin&"
//                +"redirect_uri=http://admin.nb.com:8080/oauth/callback&"
//                +"response_type=code&"
//                +"state=/index";

        }
    });


    $(document).ready(function(){
        $.get("/me",function(data,status){
            if(data){
                //已登录
                var htm = "已登录,<a onclick='logout()' href='#'>退出</a>";
                $("#loginTip").html(htm);
            }else{
                //未登录
                var href = "<a href='/toAuthLogin'>未登录，去登录</a>";
                $("#loginTip").append(href);
            }
        });
    });

</script>
</html>